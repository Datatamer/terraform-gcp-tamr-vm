#! /bin/bash
%{ if bootstrap_node == true }
# requirements
apt-get update && \
    apt-get -qy full-upgrade && \
    apt-get install -qy apt-utils && \
    apt-get install -qy wget curl apt-transport-https ca-certificates gnupg unzip

# postges 12 bins
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && \
    echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" |sudo tee  /etc/apt/sources.list.d/pgdg.list && \
    apt-get update && \
    apt-get install -qy  postgresql-client-12

# gcloud
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list && curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg  add -
apt-get update -y && apt-get install google-cloud-sdk -y

# set ulimits
cat << EOF > /etc/security/limits.d/99-tamr.conf
*               soft    nofile       1000000
*               hard    nofile       1000000
*               soft    nproc        104381
*               hard    nproc        104381
EOF
ulimit -n 104381

# set vm.max_map_count
sysctl -w vm.max_map_count=262144

%{ endif }
# script to download and install tamr
gsutil cp gs://${tamr_filesystem_bucket}/${startup_script_path} /tmp/startup_script.sh
/bin/bash /tmp/startup_script.sh
